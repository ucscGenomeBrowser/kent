#!/bin/bash -e

# align-genbank [-finish] [-workdir dir]

# Script to do alignment part of build.  This is normally called by
# genbank-build, however it can be run by hand if the alignment needs to
# be manuall completed.  Edit this file to add new genomes and assemblies.
# 
# -finish - Finish processing an alignment that was completed by hand.
# -workdir dir - set the workdir, need with -finish if the date has
#  changed since the alignment was started.
#

# errors terminate with message
set -e
trap "echo Error: genbank-align failed on `hostname` >&2; exit 1" ERR
exec </dev/null

# config
databases="hg15 mm3 rn3 hg16 fr1 dm1"

# initialize
gbRoot=/cluster/store5/genbank
cd $gbRoot
. $gbRoot/lib/gbCommon.sh

buildTime=var/build/build.time

finish=""
while [[ $1 == -* ]] ; do
    opt=$1
    shift
    case "$opt" in
        -finish) 
            finish="-continue=finish" ;;
        -workdir)
            workdir="$1"
            shift ;;
        -*) echo "Error: invalid option $opt" >&2
            exit 1 ;;
    esac
done

# allow 250mb core dumps
ulimit -c 256000

# setup workdir unless specified on command line
if [ "x$workdir" = "x" ] ; then
    date=`date +"%Y.%m.%d"`
    workdir="work/daily/align.$date"
fi

# align on large cluster, rsyncing to iservers
clusterdir=/iscratch/genbank

nice gbAlignStep $finish -workdir=$workdir -clusterRootDir=$clusterdir $databases

gbMkTimeFile $buildTime

