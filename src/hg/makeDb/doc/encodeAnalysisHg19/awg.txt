# for emacs: -*- mode: sh; -*-
#############################################################################
# ENCODE Analysis Working Group (AWG) tracks on hg19 
#
# Data in these tracks are generated by uniform processing pipelines that merge replicates
# and apply consistent analysis across different data production labs, so they are
# of greater interest to most users (and easier to use) than the ENCODE lab tracks.
#
# Wiki pages for AWG: 

#############################################################################
# Uniform DNase peaks (2012-07-26 started, 2012-12-06 in progress kate)
#
# Note - this work started in conjunction with update of ENCODE Regulation super-track
# as it is needed for the DNase Clusters track.
#
# Bob Thurman at UW ENCODE (Stam lab) generated this data by running the UW HotSpot
# pipeline on UW and Duke datasets (aligned reads).  
# It is currently hosted on the ENCODE Analysis Hub.
# Note: DNase signal tracks from AWG are also available on the hub -- these
# were generated from aligned reads using the wiggler pipeline, 
# without any replicate or lab merging.

    cd /hive/data/genomes/hg19/bed
    mkdir -p wgEncodeAwgDnase

    # Track composite will be wgEncodeAwgDnaseUniform
    # peaks are relegated to a view. 

    # get track description, trackDb, and files from EBI site that hosts analysis hub
    wget http://www.ebi.ac.uk/~swilder/ENCODE/awgHub/hg19/uniformDnase.html
    wget http://www.ebi.ac.uk/~swilder/ENCODE/awgHub/hg19/uniformDnase.txt
    cp uniformDnase.html ~/kent/src/hg/makeDb/trackDb/human/hg19/wgEncodeAwgDnaseUniform.html
    sed -n 's/bigDataUrl /wget /p' uniformDnase.txt > wget.csh

    mkdir bb narrowPeak
    cd bb
    csh ../wget.csh >&! ../wget.out &
# 125 files (.bb), dated Nov 22, 2011
# Sample case had ~150K peaks (by bigBedInfo)
# These are narrowPeak (by bigBedSummary) w/ position & signalVal, no name, score or stats
#$ bigBedToBed wgEncodeUwDnaseSKNMC.fdr01peaks.hg19.bb stdout | head
chr1    10180   10330   .       0       .       26.000000       -1      -1      -1

    # rename to UCSC style and convert to bed: wgEncodeAwgDnase<lab><cell>UniPk.narrowPeak
    ls *.fdr01peaks.hg19.bb | \
        perl -wpe 's^(wgEncode)(\S+)(Dnase)(\S+)(.fdr01peaks.hg19.bb)^bigBedToBed $1$2$3$4$5 ../narrowPeak/$1Awg$3\u\L$2\E\u\L$4\EUniPk.narrowPeak^' > ../unbig.csh

    # convert to bed and rename
    csh ../unbig.csh >&! ../unbig.out &
    # unbig.out is empty, all went OK

    cd narrowPeak
cat > ../loadDnase.csh << 'EOF'
    set b = wgEncodeAwgDnase
    set v = ${b}Uniform
    set t = ../$b.ra
    set m = ../$b.metaDb.ra
    rm -f $t $m
    #gunzip *.gz
    foreach f (${b}*.narrowPeak)
        set table = $f:r
        hgLoadBed -noNameIx -fillInScore=signalValue -trimSqlTable -sqlTable=$HOME/kent/src/hg/lib/encode/narrowPeak.sql -renameSqlTable -as=$HOME/kent/src/hg/lib/encode/narrowPeak.as hg19 $table $f
        gzip $f
        set md5sum = `md5sum $f.gz | awk '{print $1}'`
        set lab = `echo $table | perl -wpe 's/(wgEncodeAwgDnase)([A-Z][a-z]+)(.*)UniPk/$2/'`
        set cell = `echo $table | perl -wpe 's/(wgEncodeAwgDnase)([A-Z][a-z]+)(.*)UniPk/$3/'`
        echo "    track $table" >> $t
        echo "    type narrowPeak" >> $t
        echo "    parent $v" >> $t
        echo "    shortLabel $cell DNase" >> $t
        echo "    longLabel $cell DNaseI HS Uniform Peaks from ENCODE/Analysis" >> $t
        echo "    subGroups cellType=$cell treatment=None lab=$lab view=Peaks" >> $t
        echo "" >> $t

        echo "    metaObject $table" >> $m
        echo "    objType table" >> $m
        echo "    cell $cell" >> $m
        echo "    treatment None" >> $m
        echo "    composite $b" >> $m
        echo "    dataType DnaseSeq" >> $m
        echo "    dataVersion ENCODE Jan 2011 Freeze" >> $m
        echo "    dccAccession X" >> $m
        echo "    project wgEncode" >> $m
        echo "    tableName $table" >> $m
        echo "    fileName $f.gz" >> $m
        echo "    md5sum $md5sum" >> $m
        echo "    view Peaks" >> $m
        echo "" >> $m
    end
'EOF'

csh ../loadDnase.csh >&! ../loadDnase.out &

    set trackDb = ~/kent/src/hg/makeDb/trackDb/human/hg19
    cp wgEncodeAwgDnase.ra $trackDb
    # merge in composite settings from analysis hub, edit labels for length, treatment
    # note: raToTab and google spreadsheet greatly help with 17-char shortLabel adjustment
    # We could use a tabToRa too...

    cp wgEncodeAwgDnase.metaDb.ra $trackDb/metaDb/alpha/wgEncodeAwgDnase.ra
    pushd $trackDb/human/hg19/metaDb/alpha
    # add composite settings (as in ENCODE UW Dnase track)
    # edit cells, treatments to match CV.  
    mdbUpdate hg19 -test wgEncodeAwgDnase.ra

    popd
    # obtain lab and DCC accession from metaDb
    rm -f accession.metaDb.ra
    mdbPrint hg19 -vars="lab=UW replicate=1 dataType=DnaseSeq view=Peaks" | egrep 'metaObject|objType|lab |cell|treatment|dccAccession|dataVersion|^$' | sed -e 's/wgEncodeUwDnase/wgEncodeAwgDnaseUw/' -e 's/PkRep1/UniPk/' > accession.metaDb.ra
    mdbPrint hg19 -vars="lab=Duke dataType=DnaseSeq view=Peaks" | egrep 'metaObject|objType|lab |cell|treatment|dccAccession|dataVersion|^$' | sed -e 's/wgEncodeOpenChromDnase/wgEncodeAwgDnaseDuke/' -e 's/Pk/UniPk/' >> accession.metaDb.ra
    raMerge accession.metaDb.ra $trackDb/metaDb/alpha/wgEncodeAwgDnase.ra > metaDb.new.ra
    mv metaDb.new.ra $trackDb/metaDb/alpha/wgEncodeAwgDnase.new.ra
    # edit to remove orphan stanzas
    # note -- could have used above to get CV cell type as well (I did this manually)

    mkdir downloads

    # set up file downloads in expected locale
    set dir = /hive/groups/encode/dcc/pipeline/downloads/hg19

    # must use name of composite
    mkdir -p $dir/wgEncodeAwgDnaseUniform
    cd $dir/wgEncodeAwgDnaseUniform

    # setup downloads area in ENCODE 2 standard fashion (as on encodewiki 'Data Wrangler HOWTO')
    mkdir release1
    ln -s release1 beta
    ln -s release1 releaseLatest

    cd /hive/genomes/hg19/bed/wgEncodeAwgDnase/narrowPeaks
cat  << 'EOF' > link.csh
    foreach f (*.gz)
        echo $f
        ln $f /hive/groups/encode/dcc/pipeline/downloads/hg19/wgEncodeAwgDnaseUniform/releaseLatest
    end
'EOF'
    csh link.csh
    cd $dir/wgEncodeAwgDnaseUniform/releaseLatest


    # add files.txt
    encodeMkFilesList hg19 

    # add README
    sed 's/wgEncodeUwDnase/wgEncodeAwgDnaseUniform/' $dir/wgEncodeUwDnase/README.txt > $dir/wgEncodeAwgDnaseUniform
    cp $dir/wgEncodeUwDnase/README.txt $dir/wgEncodeAwgDnaseUniform/releaseLatest

    # get file list for pushQ
    cd ~/kent/src/hg/makeDb/doc/encodeAnalysisHg19
    /cluster/bin/scripts/encodeMkChangeNotes hg19 wgEncodeAwgDnaseUniform 1

    










