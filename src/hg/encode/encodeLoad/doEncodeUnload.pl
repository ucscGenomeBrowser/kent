#!/usr/bin/env perl

# encodeUnload.pl - unload ENCODE data submission generated by the
#                       automated submission pipeline
# Reads load.ra for information about what to do

# Writes error or log information to STDOUT
# Returns 0 if unload succeeds.

# DO NOT EDIT the /cluster/bin/scripts copy of this file -- 
# edit the CVS'ed source at: ~/kent/src/hg/encode/encodeUnload/doEncodeUnload.pl
#
# $Id: doEncodeUnload.pl,v 1.1 2008/08/12 18:16:42 larrym Exp $

use warnings;
use strict;

use Getopt::Long;
use File::Basename;

use lib "/cluster/bin/scripts";
use Encode;
use HgDb;
use HgAutomate;

use vars qw/$opt_verbose/;

sub usage
{
    print STDERR <<END;
    usage: doEncodeUnload.pl submission_type project_submission_dir
END
    exit(1);
}

sub genericUnload
{
    my ($assembly, $db, $tableName) = @_;
    $db->dropTableIfExist($tableName);
}

sub unloadWig
{
    my ($assembly, $db, $tableName) = @_;
    $db->dropTableIfExist($tableName);

    # remove symlink
    my $file = "/gbdb/$assembly/wib/$tableName.wib";
    if(-e $file) {
        HgAutomate::verbose(3, "removing wib '$file'\n");
        if(system("rm -f $file")) {
            die "unexpected error removing symlink $file";
        }
    }
}
 
############################################################################
# Main

# Change dir to submission directory obtained from command-line

GetOptions("verbose=i") || usage();
$opt_verbose = 1 if (!defined $opt_verbose);
if(@ARGV != 2) {
    usage();
}

my $submitType = $ARGV[0];	# currently not used
my $submitDir = $ARGV[1];	# directory where data files are

my $tableSuffix = "";
# yank out "beta" from encinstance_beta
if(dirname($submitDir) =~ /(_.*)/) {
    $tableSuffix = "$1_" . basename($submitDir);;
} else {
    $tableSuffix = "_" . basename($submitDir);;
}

chdir($submitDir) || die "Couldn't chdir to '$submitDir'";

my $unloadRa = 'out/unload.ra';
if(!(-e $unloadRa)) {
    HgAutomate::verbose(2, "Skipping unload b/c '$unloadRa' doesn't exist\n");
    exit(0);
}

HgAutomate::verbose(2, "Unloading project in directory $submitDir\n");

# Unload resources listed in unload.ra
my %ra = RAFile::readRaFile($unloadRa, 'tablename');
my $db;
for my $key (keys %ra) {
    my $h = $ra{$key};
    my $tablename = $h->{tablename} . $tableSuffix;

    my $str = "\nkeyword: $key\n";
    for my $field (qw(tablename type assembly files)) {
        if($h->{$field}) {
            $str .= "$field: " . $h->{$field} . "\n";
        }
    }
    $str .= "\n";
    HgAutomate::verbose(3, $str);

    my $assembly = $h->{assembly};
    if(!defined($db)) {
        $db = HgDb->new(DB => $assembly);
    }

    HgAutomate::verbose(2, "Dropping table '$tablename'\n");

    my %extendedTypes = map { $_ => 1 } @Encode::extendedTypes;
    my $type = $h->{type};
    if($type eq "genePred" || $type =~ /^bed/ || $extendedTypes{$type}) {
        genericUnload($assembly, $db, $tablename);
    } elsif ($type eq "wig") {
        unloadWig($assembly, $db, $tablename);
    } elsif ($type eq "fastq") {
        ;
    } else {
        die "ERROR: unknown type: $h->{type} in load.ra\n";
    }
}

exit(0);
